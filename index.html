<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Contracts via MetaMask</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #5568d3; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .address {
            font-family: monospace;
            background: #eee;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Deploy Contracts via MetaMask</h1>
        
        <div class="info">
            <strong>Network:</strong> DIDLab (Chain ID: 252501)<br>
            <strong>Status:</strong> <span id="status">Not connected</span><br>
            <strong>Account:</strong> <span id="account">-</span><br>
            <strong>Balance:</strong> <span id="balance">-</span>
        </div>

        <button onclick="connectWallet()" id="connectBtn">Connect MetaMask</button>
        <button onclick="deployPatientRegistry()" id="deployPRBtn" disabled>Deploy PatientRegistry</button>
        <button onclick="deployPayment()" id="deployPaymentBtn" disabled>Deploy Payment</button>
        <button onclick="downloadDeployment()" id="downloadBtn" disabled>Download deployment.json</button>

        <div id="message"></div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let provider, signer, account;
        let deploymentData = {
            network: "didlab",
            chainId: 252501,
            contracts: {}
        };

        // Compiled contract data
        const PATIENT_REGISTRY_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":false,"internalType":"string","name":"memberID","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PatientDeactivated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":false,"internalType":"string","name":"memberID","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PatientRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":false,"internalType":"string","name":"memberID","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PatientUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":true,"internalType":"address","name":"providerAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"ProviderAssigned","type":"event"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"},{"internalType":"address","name":"_providerAddress","type":"address"}],"name":"assignProvider","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_memberID","type":"string"}],"name":"checkMemberID","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"}],"name":"deactivatePatient","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllPatientAddresses","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyMemberID","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"}],"name":"getPatient","outputs":[{"internalType":"string","name":"memberID","type":"string"},{"internalType":"uint256","name":"registrationTimestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"address","name":"assignedProvider","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"getPatientAddressAtIndex","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_memberID","type":"string"}],"name":"getPatientAddressByMemberID","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"}],"name":"getPatientData","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalPatients","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"isMemberIDRegistered","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isRegistered","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"memberIDToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"patientAddresses","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"patients","outputs":[{"internalType":"string","name":"memberID","type":"string"},{"internalType":"uint256","name":"registrationTimestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"address","name":"assignedProvider","type":"address"},{"internalType":"string","name":"encryptedData","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_memberID","type":"string"},{"internalType":"string","name":"_encryptedData","type":"string"}],"name":"registerPatient","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalPatientsRegistered","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_encryptedData","type":"string"}],"name":"updatePatientData","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
        const PATIENT_REGISTRY_BYTECODE = "0x608060405234801561000f575f80fd5b503360045f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550612a768061005d5f395ff3fe608060405234801561000f575f80fd5b506004361061012a575f3560e01c80638da5cb5b116100ab578063b5368e201161006f578063b5368e20146103ba578063f2fde38b146103ed578063f4220a0214610409578063f497e18914610439578063f86854fe146104575761012a565b80638da5cb5b146102ee5780638f0361e71461030c57806392be3e651461033c578063aa9099401461035a578063b40f16911461038a5761012a565b806348e81852116100f257806348e81852146101fe5780635a10aed01461022e5780636647555e1461025e5780637ef3291f1461028e57806380911fa4146102be5761012a565b80630869cfbc1461012e57806322366844146101625780632c7e4c811461018057806345cc5ab4146101b057806348d46d97146101ce575b5f80fd5b61014860048036038101906101439190611b20565b610475565b604051610159959493929190611c16565b60405180910390f35b61016a6105de565b6040516101779190611c75565b60405180910390f35b61019a60048036038101906101959190611c8e565b610630565b6040516101a79190611c75565b60405180910390f35b6101b86108a6565b6040516101c59190611ccc565b60405180910390f35b6101e860048036038101906101e39190611e18565b6109fd565b6040516101f59190611c75565b60405180910390f35b61021860048036038101906102139190611b20565b610baf565b6040516102259190611ccc565b60405180910390f35b61024860048036038101906102439190611b20565b610dd0565b6040516102559190611c75565b60405180910390f35b61027860048036038101906102739190611e18565b610fd7565b6040516102859190611c75565b60405180910390f35b6102a860048036038101906102a39190611e18565b61100c565b6040516102b59190611c75565b60405180910390f35b6102d860048036038101906102d39190611e5f565b61103f565b6040516102e59190611c75565b60405180910390f35b6102f6611439565b6040516103039190611ed5565b60405180910390f35b61032660048036038101906103219190611f18565b61145e565b6040516103339190611ed5565b60405180910390f35b610344611578565b6040516103519190611ffa565b60405180910390f35b610374600480360381019061036f9190611e18565b611692565b6040516103819190611ed5565b60405180910390f35b6103a4600480360381019061039f9190611f18565b6116da565b6040516103b19190611ed5565b60405180910390f35b6103d460048036038101906103cf9190611b20565b611715565b6040516103e4949392919061201a565b60405180910390f35b61040760048036038101906104029190611b20565b611920565b005b610423600480360381019061041e9190611e18565b611a60565b6040516104309190611ed5565b60405180910390f35b610441611aa6565b60405161044e9190612064565b60405180910390f35b61045f611aaf565b60405161046c9190612064565b60405180910390f35b5f602052805f5260405f205f91509050805f018054610493906120aa565b80601f01602080910402602001604051908101604052809291908181526020018280546104bf906120aa565b801561050a5780601f106104e15761010080835404028352916020019161050a565b820191905f5260205f20905b8154815290600101906020018083116104ed57829003601f168201915b505050505090806001015490806002015f9054906101000a900460ff16908060020160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600301805461055d906120aa565b80601f0160208091040260200160405190810160405280929190818152602001828054610589906120aa565b80156105d45780601f106105ab576101008083540402835291602001916105d4565b820191905f5260205f20905b8154815290600101906020018083116105b757829003601f168201915b5050505050905085565b5f805f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f9054906101000a900460ff16905090565b5f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146106c0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106b79061214a565b60405180910390fd5b5f808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f9054906101000a900460ff1661074b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610742906121b2565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036107b9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107b09061221a565b60405180910390fd5b815f808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2060020160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fa1929ec9ddfdaf3a142cdb9dcbd66fcbeaabd67dd0cbfe5857c9af461c992cab426040516108949190612064565b60405180910390a36001905092915050565b60605f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f9054906101000a900460ff16610933576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161092a90612282565b60405180910390fd5b5f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f01805461097c906120aa565b80601f01602080910402602001604051908101604052809291908181526020018280546109a8906120aa565b80156109f35780601f106109ca576101008083540402835291602001916109f3565b820191905f5260205f20905b8154815290600101906020018083116109d657829003601f168201915b5050505050905090565b5f805f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f9054906101000a900460ff16610a89576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a80906121b2565b60405180910390fd5b5f825111610acc576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ac3906122ea565b60405180910390fd5b815f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206003019081610b1891906124a5565b503373ffffffffffffffffffffffffffffffffffffffff167f474cca1c43e391565f581648e6e8c3b04e9cfb6061f572912446ffd86cb9b79e5f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f0142604051610b9e9291906125f5565b60405180910390a260019050919050565b6060818073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161480610c38575060045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b610c77576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c6e90612693565b60405180910390fd5b5f808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f9054906101000a900460ff16610d02576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cf9906121b2565b60405180910390fd5b5f808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206003018054610d4c906120aa565b80601f0160208091040260200160405190810160405280929190818152602001828054610d78906120aa565b8015610dc35780601f10610d9a57610100808354040283529160200191610dc3565b820191905f5260205f20905b815481529060010190602001808311610da657829003601f168201915b5050505050915050919050565b5f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610e60576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e579061214a565b60405180910390fd5b5f808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f9054906101000a900460ff16610eeb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ee2906126fb565b60405180910390fd5b5f805f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f6101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff167fa3df1249bb32aace6e309884e0b094998273ac8936a275946316c7cc7ce6c0f85f808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f0142604051610fc69291906125f5565b60405180910390a260019050919050565b6002818051602081018201805184825260208301602085012081835280955050505050505f915054906101000a900460ff1681565b5f60028260405161101d9190612753565b90815260200160405180910390205f9054906101000a900460ff169050919050565b5f80835111611083576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161107a906127b3565b60405180910390fd5b5f8251116110c6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110bd906122ea565b60405180910390fd5b5f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206002015f9054906101000a900460ff1615611152576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016111499061281b565b60405180910390fd5b6002836040516111629190612753565b90815260200160405180910390205f9054906101000a900460ff16156111bd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016111b490612883565b60405180910390fd5b6040518060a001604052808481526020014281526020016001151581526020015f73ffffffffffffffffffffffffffffffffffffffff168152602001838152505f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f820151815f01908161124c91906124a5565b50602082015181600101556040820151816002015f6101000a81548160ff02191690831515021790555060608201518160020160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060808201518160030190816112d291906124a5565b50905050336001846040516112e79190612753565b90815260200160405180910390205f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060016002846040516113449190612753565b90815260200160405180910390205f6101000a81548160ff021916908315150217905550600333908060018154018082558091505060019003905f5260205f20015f9091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060055f8154809291906113da906128ce565b91905055503373ffffffffffffffffffffffffffffffffffffffff167f096f893428730b9f440cde9930f6fbd450ce2d7ac1f2895f0d869da7376a36d18442604051611427929190612915565b60405180910390a26001905092915050565b60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146114ee576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114e59061214a565b60405180910390fd5b6003805490508210611535576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161152c9061298d565b60405180910390fd5b60038281548110611549576115486129ab565b5b905f5260205f20015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b606060045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611609576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016116009061214a565b60405180910390fd5b600380548060200260200160405190810160405280929190818152602001828054801561168857602002820191905f5260205f20905b815f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161163f575b5050505050905090565b6001818051602081018201805184825260208301602085012081835280955050505050505f915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600381815481106116e9575f80fd5b905f5260205f20015f915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60605f805f805f808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206040518060a00160405290815f82018054611771906120aa565b80601f016020809104026020016040519081016040528092919081815260200182805461179d906120aa565b80156117e85780601f106117bf576101008083540402835291602001916117e8565b820191905f5260205f20905b8154815290600101906020018083116117cb57829003601f168201915b5050505050815260200160018201548152602001600282015f9054906101000a900460ff161515151581526020016002820160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160038201805461187b906120aa565b80601f01602080910402602001604051908101604052809291908181526020018280546118a7906120aa565b80156118f25780601f106118c9576101008083540402835291602001916118f2565b820191905f5260205f20905b8154815290600101906020018083116118d557829003601f168201915b5050505050815250509050805f01518160200151826040015183606001519450945094509450509193509193565b60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146119af576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016119a69061214a565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603611a1d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611a1490612a22565b60405180910390fd5b8060045f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b5f600182604051611a719190612753565b90815260200160405180910390205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b5f600554905090565b60055481565b5f604051905090565b5f80fd5b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f611aef82611ac6565b9050919050565b611aff81611ae5565b8114611b09575f80fd5b50565b5f81359050611b1a81611af6565b92915050565b5f60208284031215611b3557611b34611abe565b5b5f611b4284828501611b0c565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f5b83811015611b82578082015181840152602081019050611b67565b5f8484015250505050565b5f601f19601f8301169050919050565b5f611ba782611b4b565b611bb18185611b55565b9350611bc1818560208601611b65565b611bca81611b8d565b840191505092915050565b5f819050919050565b611be781611bd5565b82525050565b5f8115159050919050565b611c0181611bed565b82525050565b611c1081611ae5565b82525050565b5f60a0820190508181035f830152611c2e8188611b9d565b9050611c3d6020830187611bde565b611c4a6040830186611bf8565b611c576060830185611c07565b8181036080830152611c698184611b9d565b90509695505050505050565b5f602082019050611c885f830184611bf8565b92915050565b5f8060408385031215611ca457611ca3611abe565b5b5f611cb185828601611b0c565b9250506020611cc285828601611b0c565b9150509250929050565b5f6020820190508181035f830152611ce48184611b9d565b905092915050565b5f80fd5b5f80fd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b611d2a82611b8d565b810181811067ffffffffffffffff82111715611d4957611d48611cf4565b5b80604052505050565b5f611d5b611ab5565b9050611d678282611d21565b919050565b5f67ffffffffffffffff821115611d8657611d85611cf4565b5b611d8f82611b8d565b9050602081019050919050565b828183375f83830152505050565b5f611dbc611db784611d6c565b611d52565b905082815260208101848484011115611dd857611dd7611cf0565b5b611de3848285611d9c565b509392505050565b5f82601f830112611dff57611dfe611cec565b5b8135611e0f848260208601611daa565b91505092915050565b5f60208284031215611e2d57611e2c611abe565b5b5f82013567ffffffffffffffff811115611e4a57611e49611ac2565b5b611e5684828501611deb565b91505092915050565b5f8060408385031215611e7557611e74611abe565b5b5f83013567ffffffffffffffff811115611e9257611e91611ac2565b5b611e9e85828601611deb565b925050602083013567ffffffffffffffff811115611ebf57611ebe611ac2565b5b611ecb85828601611deb565b9150509250929050565b5f602082019050611ee85f830184611c07565b92915050565b611ef781611bd5565b8114611f01575f80fd5b50565b5f81359050611f1281611eee565b92915050565b5f60208284031215611f2d57611f2c611abe565b5b5f611f3a84828501611f04565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b611f7581611ae5565b82525050565b5f611f868383611f6c565b60208301905092915050565b5f602082019050919050565b5f611fa882611f43565b611fb28185611f4d565b9350611fbd83611f5d565b805f5b83811015611fed578151611fd48882611f7b565b9750611fdf83611f92565b925050600181019050611fc0565b5085935050505092915050565b5f6020820190508181035f8301526120128184611f9e565b905092915050565b5f6080820190508181035f8301526120328187611b9d565b90506120416020830186611bde565b61204e6040830185611bf8565b61205b6060830184611c07565b95945050505050565b5f6020820190506120775f830184611bde565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806120c157607f821691505b6020821081036120d4576120d361207d565b5b50919050565b7f4f6e6c79206f776e65722063616e2063616c6c20746869732066756e6374696f5f8201527f6e00000000000000000000000000000000000000000000000000000000000000602082015250565b5f612134602183611b55565b915061213f826120da565b604082019050919050565b5f6020820190508181035f83015261216181612128565b9050919050565b7f50617469656e74206e6f742072656769737465726564000000000000000000005f82015250565b5f61219c601683611b55565b91506121a782612168565b602082019050919050565b5f6020820190508181035f8301526121c981612190565b9050919050565b7f496e76616c69642070726f7669646572206164647265737300000000000000005f82015250565b5f612204601883611b55565b915061220f826121d0565b602082019050919050565b5f6020820190508181035f830152612231816121f8565b9050919050565b7f596f7520617265206e6f742072656769737465726564000000000000000000005f82015250565b5f61226c601683611b55565b915061227782612238565b602082019050919050565b5f6020820190508181035f83015261229981612260565b9050919050565b7f456e6372797074656420646174612063616e6e6f7420626520656d70747900005f82015250565b5f6122d4601e83611b55565b91506122df826122a0565b602082019050919050565b5f6020820190508181035f830152612301816122c8565b9050919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026123647fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82612329565b61236e8683612329565b95508019841693508086168417925050509392505050565b5f819050919050565b5f6123a96123a461239f84611bd5565b612386565b611bd5565b9050919050565b5f819050919050565b6123c28361238f565b6123d66123ce826123b0565b848454612335565b825550505050565b5f90565b6123ea6123de565b6123f58184846123b9565b505050565b5b818110156124185761240d5f826123e2565b6001810190506123fb565b5050565b601f82111561245d5761242e81612308565b6124378461231a565b81016020851015612446578190505b61245a6124528561231a565b8301826123fa565b50505b505050565b5f82821c905092915050565b5f61247d5f1984600802612462565b1980831691505092915050565b5f612495838361246e565b9150826002028217905092915050565b6124ae82611b4b565b67ffffffffffffffff8111156124c7576124c6611cf4565b5b6124d182546120aa565b6124dc82828561241c565b5f60209050601f83116001811461250d575f84156124fb578287015190505b612505858261248a565b86555061256c565b601f19841661251b86612308565b5f5b828110156125425784890151825560018201915060208501945060208101905061251d565b8683101561255f578489015161255b601f89168261246e565b8355505b6001600288020188555050505b505050505050565b5f8154612580816120aa565b61258a8186611b55565b9450600182165f81146125a457600181146125ba576125ec565b60ff1983168652811515602002860193506125ec565b6125c385612308565b5f5b838110156125e4578154818901526001820191506020810190506125c5565b808801955050505b50505092915050565b5f6040820190508181035f83015261260d8185612574565b905061261c6020830184611bde565b9392505050565b7f4f6e6c792070617469656e74206f72206f776e65722063616e2063616c6c20745f8201527f6869732066756e6374696f6e0000000000000000000000000000000000000000602082015250565b5f61267d602c83611b55565b915061268882612623565b604082019050919050565b5f6020820190508181035f8301526126aa81612671565b9050919050565b7f50617469656e74206e6f742061637469766500000000000000000000000000005f82015250565b5f6126e5601283611b55565b91506126f0826126b1565b602082019050919050565b5f6020820190508181035f830152612712816126d9565b9050919050565b5f81905092915050565b5f61272d82611b4b565b6127378185612719565b9350612747818560208601611b65565b80840191505092915050565b5f61275e8284612723565b915081905092915050565b7f4d656d6265722049442063616e6e6f7420626520656d707479000000000000005f82015250565b5f61279d601983611b55565b91506127a882612769565b602082019050919050565b5f6020820190508181035f8301526127ca81612791565b9050919050565b7f50617469656e7420616c726561647920726567697374657265640000000000005f82015250565b5f612805601a83611b55565b9150612810826127d1565b602082019050919050565b5f6020820190508181035f830152612832816127f9565b9050919050565b7f4d656d62657220494420616c72656164792072656769737465726564000000005f82015250565b5f61286d601c83611b55565b915061287882612839565b602082019050919050565b5f6020820190508181035f83015261289a81612861565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6128d882611bd5565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361290a576129096128a1565b5b600182019050919050565b5f6040820190508181035f83015261292d8185611b9d565b905061293c6020830184611bde565b9392505050565b7f496e646578206f7574206f6620626f756e6473000000000000000000000000005f82015250565b5f612977601383611b55565b915061298282612943565b602082019050919050565b5f6020820190508181035f8301526129a48161296b565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b7f4e6577206f776e65722063616e6e6f74206265207a65726f20616464726573735f82015250565b5f612a0c602083611b55565b9150612a17826129d8565b602082019050919050565b5f6020820190508181035f830152612a3981612a00565b905091905056fea264697066735822122034ce51258b8ef79ad8e2ee98e7c31d6d562904474711a90a36b803a3d9e2e77464736f6c63430008140033";
        
        const PAYMENT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FundsWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"string","name":"paymentId","type":"string"},{"indexed":false,"internalType":"string","name":"itemId","type":"string"},{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PaymentProcessed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"PaymentReceived","type":"event"},{"inputs":[{"internalType":"string","name":"_paymentId","type":"string"}],"name":"getPayment","outputs":[{"internalType":"string","name":"itemId","type":"string"},{"internalType":"string","name":"itemType","type":"string"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getStats","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserPayments","outputs":[{"internalType":"string[]","name":"","type":"string[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_itemId","type":"string"}],"name":"isItemPaid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"itemPaid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"payments","outputs":[{"internalType":"string","name":"itemId","type":"string"},{"internalType":"string","name":"itemType","type":"string"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"string","name":"memberID","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_paymentId","type":"string"},{"internalType":"string","name":"_itemId","type":"string"},{"internalType":"string","name":"_itemType","type":"string"},{"internalType":"string","name":"_memberID","type":"string"}],"name":"processPayment","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"totalAmountProcessed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalPaymentsProcessed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userPayments","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
        const PAYMENT_BYTECODE = "0x608060405234801561000f575f80fd5b503360055f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611fe48061005d5f395ff3fe6080604052600436106100aa575f3560e01c80638da5cb5b116100635780638da5cb5b146102275780639d7dadeb14610251578063c59d48471461028d578063c69207a3146102b9578063d991a2b9146102fa578063f946871314610336576100ff565b80630a3a4c42146101035780632e1a7d4d1461012d57806337e32d1d146101555780634ac6c4471461017f5780635bc0716a146101af5780638cfeab35146101eb576100ff565b366100ff573373ffffffffffffffffffffffffffffffffffffffff167f6ef95f06320e7a25a04a175ca677b7052bdd97131872c2192525a629f51be770346040516100f59190611110565b60405180910390a2005b5f80fd5b34801561010e575f80fd5b50610117610378565b6040516101249190611110565b60405180910390f35b348015610138575f80fd5b50610153600480360381019061014e9190611164565b61037e565b005b348015610160575f80fd5b5061016961058c565b6040516101769190611110565b60405180910390f35b610199600480360381019061019491906112cb565b610592565b6040516101a691906113b9565b60405180910390f35b3480156101ba575f80fd5b506101d560048036038101906101d091906113d2565b6109eb565b6040516101e291906113b9565b60405180910390f35b3480156101f6575f80fd5b50610211600480360381019061020c9190611473565b610a1e565b60405161021e919061152b565b60405180910390f35b348015610232575f80fd5b5061023b610acf565b604051610248919061155a565b60405180910390f35b34801561025c575f80fd5b5061027760048036038101906102729190611573565b610af4565b60405161028491906116a1565b60405180910390f35b348015610298575f80fd5b506102a1610c05565b6040516102b0939291906116c1565b60405180910390f35b3480156102c4575f80fd5b506102df60048036038101906102da91906113d2565b610c1a565b6040516102f1969594939291906116f6565b60405180910390f35b348015610305575f80fd5b50610320600480360381019061031b91906113d2565b610eb1565b60405161032d91906113b9565b60405180910390f35b348015610341575f80fd5b5061035c600480360381019061035791906113d2565b610ee6565b60405161036f9796959493929190611763565b60405180910390f35b60045481565b60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461040d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161040490611855565b60405180910390fd5b47811115610450576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610447906118bd565b60405180910390fd5b5f60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168260405161049690611908565b5f6040518083038185875af1925050503d805f81146104d0576040519150601f19603f3d011682016040523d82523d5f602084013e6104d5565b606091505b5050905080610519576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161051090611966565b60405180910390fd5b60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167feaff4b37086828766ad3268786972c0cd24259d4c87a80f9d3963a3c3d999b0d836040516105809190611110565b60405180910390a25050565b60035481565b5f8034116105d5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105cc906119f4565b60405180910390fd5b5f855111610618576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161060f90611a5c565b60405180910390fd5b5f84511161065b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161065290611ac4565b60405180910390fd5b5f8560405161066a9190611b1c565b90815260200160405180910390206005015f9054906101000a900460ff16156106c8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106bf90611b7c565b60405180910390fd5b6001846040516106d89190611b1c565b90815260200160405180910390205f9054906101000a900460ff1615610733576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161072a90611be4565b60405180910390fd5b6040518060e001604052808581526020018481526020013373ffffffffffffffffffffffffffffffffffffffff168152602001348152602001428152602001600115158152602001838152505f8660405161078e9190611b1c565b90815260200160405180910390205f820151815f0190816107af9190611dfc565b5060208201518160010190816107c59190611dfc565b506040820151816002015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550606082015181600301556080820151816004015560a0820151816005015f6101000a81548160ff02191690831515021790555060c08201518160060190816108549190611dfc565b50905050600180856040516108699190611b1c565b90815260200160405180910390205f6101000a81548160ff02191690831515021790555060025f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2085908060018154018082558091505060019003905f5260205f20015f9091909190915090816108f99190611dfc565b5060035f81548092919061090c90611ef8565b91905055503460045f8282546109229190611f3f565b925050819055503373ffffffffffffffffffffffffffffffffffffffff168560405161094e9190611b1c565b60405180910390207fc3de5e5e03ef24399107436755733184e0c27aee613ea44e197fdd5a624e76d586344260405161098993929190611f72565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff167f6ef95f06320e7a25a04a175ca677b7052bdd97131872c2192525a629f51be770346040516109d79190611110565b60405180910390a260019050949350505050565b5f6001826040516109fc9190611b1c565b90815260200160405180910390205f9054906101000a900460ff169050919050565b6002602052815f5260405f208181548110610a37575f80fd5b905f5260205f20015f91509150508054610a5090611c2f565b80601f0160208091040260200160405190810160405280929190818152602001828054610a7c90611c2f565b8015610ac75780601f10610a9e57610100808354040283529160200191610ac7565b820191905f5260205f20905b815481529060010190602001808311610aaa57829003601f168201915b505050505081565b60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b606060025f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20805480602002602001604051908101604052809291908181526020015f905b82821015610bfa578382905f5260205f20018054610b6f90611c2f565b80601f0160208091040260200160405190810160405280929190818152602001828054610b9b90611c2f565b8015610be65780601f10610bbd57610100808354040283529160200191610be6565b820191905f5260205f20905b815481529060010190602001808311610bc957829003601f168201915b505050505081526020019060010190610b52565b505050509050919050565b5f805f60035460045447925092509250909192565b6060805f805f805f8088604051610c319190611b1c565b90815260200160405180910390206040518060e00160405290815f82018054610c5990611c2f565b80601f0160208091040260200160405190810160405280929190818152602001828054610c8590611c2f565b8015610cd05780601f10610ca757610100808354040283529160200191610cd0565b820191905f5260205f20905b815481529060010190602001808311610cb357829003601f168201915b50505050508152602001600182018054610ce990611c2f565b80601f0160208091040260200160405190810160405280929190818152602001828054610d1590611c2f565b8015610d605780601f10610d3757610100808354040283529160200191610d60565b820191905f5260205f20905b815481529060010190602001808311610d4357829003601f168201915b50505050508152602001600282015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016003820154815260200160048201548152602001600582015f9054906101000a900460ff16151515158152602001600682018054610dfc90611c2f565b80601f0160208091040260200160405190810160405280929190818152602001828054610e2890611c2f565b8015610e735780601f10610e4a57610100808354040283529160200191610e73565b820191905f5260205f20905b815481529060010190602001808311610e5657829003601f168201915b5050505050815250509050805f015181602001518260400151836060015184608001518560a001519650965096509650965096505091939550919395565b6001818051602081018201805184825260208301602085012081835280955050505050505f915054906101000a900460ff1681565b5f818051602081018201805184825260208301602085012081835280955050505050505f91509050805f018054610f1c90611c2f565b80601f0160208091040260200160405190810160405280929190818152602001828054610f4890611c2f565b8015610f935780601f10610f6a57610100808354040283529160200191610f93565b820191905f5260205f20905b815481529060010190602001808311610f7657829003601f168201915b505050505090806001018054610fa890611c2f565b80601f0160208091040260200160405190810160405280929190818152602001828054610fd490611c2f565b801561101f5780601f10610ff65761010080835404028352916020019161101f565b820191905f5260205f20905b81548152906001019060200180831161100257829003601f168201915b505050505090806002015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806003015490806004015490806005015f9054906101000a900460ff169080600601805461107790611c2f565b80601f01602080910402602001604051908101604052809291908181526020018280546110a390611c2f565b80156110ee5780601f106110c5576101008083540402835291602001916110ee565b820191905f5260205f20905b8154815290600101906020018083116110d157829003601f168201915b5050505050905087565b5f819050919050565b61110a816110f8565b82525050565b5f6020820190506111235f830184611101565b92915050565b5f604051905090565b5f80fd5b5f80fd5b611143816110f8565b811461114d575f80fd5b50565b5f8135905061115e8161113a565b92915050565b5f6020828403121561117957611178611132565b5b5f61118684828501611150565b91505092915050565b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6111dd82611197565b810181811067ffffffffffffffff821117156111fc576111fb6111a7565b5b80604052505050565b5f61120e611129565b905061121a82826111d4565b919050565b5f67ffffffffffffffff821115611239576112386111a7565b5b61124282611197565b9050602081019050919050565b828183375f83830152505050565b5f61126f61126a8461121f565b611205565b90508281526020810184848401111561128b5761128a611193565b5b61129684828561124f565b509392505050565b5f82601f8301126112b2576112b161118f565b5b81356112c284826020860161125d565b91505092915050565b5f805f80608085870312156112e3576112e2611132565b5b5f85013567ffffffffffffffff811115611300576112ff611136565b5b61130c8782880161129e565b945050602085013567ffffffffffffffff81111561132d5761132c611136565b5b6113398782880161129e565b935050604085013567ffffffffffffffff81111561135a57611359611136565b5b6113668782880161129e565b925050606085013567ffffffffffffffff81111561138757611386611136565b5b6113938782880161129e565b91505092959194509250565b5f8115159050919050565b6113b38161139f565b82525050565b5f6020820190506113cc5f8301846113aa565b92915050565b5f602082840312156113e7576113e6611132565b5b5f82013567ffffffffffffffff81111561140457611403611136565b5b6114108482850161129e565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61144282611419565b9050919050565b61145281611438565b811461145c575f80fd5b50565b5f8135905061146d81611449565b92915050565b5f806040838503121561148957611488611132565b5b5f6114968582860161145f565b92505060206114a785828601611150565b9150509250929050565b5f81519050919050565b5f82825260208201905092915050565b5f5b838110156114e85780820151818401526020810190506114cd565b5f8484015250505050565b5f6114fd826114b1565b61150781856114bb565b93506115178185602086016114cb565b61152081611197565b840191505092915050565b5f6020820190508181035f83015261154381846114f3565b905092915050565b61155481611438565b82525050565b5f60208201905061156d5f83018461154b565b92915050565b5f6020828403121561158857611587611132565b5b5f6115958482850161145f565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f82825260208201905092915050565b5f6115e1826114b1565b6115eb81856115c7565b93506115fb8185602086016114cb565b61160481611197565b840191505092915050565b5f61161a83836115d7565b905092915050565b5f602082019050919050565b5f6116388261159e565b61164281856115a8565b935083602082028501611654856115b8565b805f5b8581101561168f5784840389528151611670858261160f565b945061167b83611622565b925060208a01995050600181019050611657565b50829750879550505050505092915050565b5f6020820190508181035f8301526116b9818461162e565b905092915050565b5f6060820190506116d45f830186611101565b6116e16020830185611101565b6116ee6040830184611101565b949350505050565b5f60c0820190508181035f83015261170e81896114f3565b9050818103602083015261172281886114f3565b9050611731604083018761154b565b61173e6060830186611101565b61174b6080830185611101565b61175860a08301846113aa565b979650505050505050565b5f60e0820190508181035f83015261177b818a6114f3565b9050818103602083015261178f81896114f3565b905061179e604083018861154b565b6117ab6060830187611101565b6117b86080830186611101565b6117c560a08301856113aa565b81810360c08301526117d781846114f3565b905098975050505050505050565b7f4f6e6c79206f776e65722063616e2063616c6c20746869732066756e6374696f5f8201527f6e00000000000000000000000000000000000000000000000000000000000000602082015250565b5f61183f6021836114bb565b915061184a826117e5565b604082019050919050565b5f6020820190508181035f83015261186c81611833565b9050919050565b7f496e73756666696369656e742062616c616e63650000000000000000000000005f82015250565b5f6118a76014836114bb565b91506118b282611873565b602082019050919050565b5f6020820190508181035f8301526118d48161189b565b9050919050565b5f81905092915050565b50565b5f6118f35f836118db565b91506118fe826118e5565b5f82019050919050565b5f611912826118e8565b9150819050919050565b7f5769746864726177616c206661696c65640000000000000000000000000000005f82015250565b5f6119506011836114bb565b915061195b8261191c565b602082019050919050565b5f6020820190508181035f83015261197d81611944565b9050919050565b7f5061796d656e7420616d6f756e74206d757374206265206772656174657220745f8201527f68616e2030000000000000000000000000000000000000000000000000000000602082015250565b5f6119de6025836114bb565b91506119e982611984565b604082019050919050565b5f6020820190508181035f830152611a0b816119d2565b9050919050565b7f5061796d656e742049442063616e6e6f7420626520656d7074790000000000005f82015250565b5f611a46601a836114bb565b9150611a5182611a12565b602082019050919050565b5f6020820190508181035f830152611a7381611a3a565b9050919050565b7f4974656d2049442063616e6e6f7420626520656d7074790000000000000000005f82015250565b5f611aae6017836114bb565b9150611ab982611a7a565b602082019050919050565b5f6020820190508181035f830152611adb81611aa2565b9050919050565b5f81905092915050565b5f611af6826114b1565b611b008185611ae2565b9350611b108185602086016114cb565b80840191505092915050565b5f611b278284611aec565b915081905092915050565b7f5061796d656e7420616c72656164792070726f636573736564000000000000005f82015250565b5f611b666019836114bb565b9150611b7182611b32565b602082019050919050565b5f6020820190508181035f830152611b9381611b5a565b9050919050565b7f4974656d20616c726561647920706169640000000000000000000000000000005f82015250565b5f611bce6011836114bb565b9150611bd982611b9a565b602082019050919050565b5f6020820190508181035f830152611bfb81611bc2565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680611c4657607f821691505b602082108103611c5957611c58611c02565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302611cbb7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82611c80565b611cc58683611c80565b95508019841693508086168417925050509392505050565b5f819050919050565b5f611d00611cfb611cf6846110f8565b611cdd565b6110f8565b9050919050565b5f819050919050565b611d1983611ce6565b611d2d611d2582611d07565b848454611c8c565b825550505050565b5f90565b611d41611d35565b611d4c818484611d10565b505050565b5b81811015611d6f57611d645f82611d39565b600181019050611d52565b5050565b601f821115611db457611d8581611c5f565b611d8e84611c71565b81016020851015611d9d578190505b611db1611da985611c71565b830182611d51565b50505b505050565b5f82821c905092915050565b5f611dd45f1984600802611db9565b1980831691505092915050565b5f611dec8383611dc5565b9150826002028217905092915050565b611e05826114b1565b67ffffffffffffffff811115611e1e57611e1d6111a7565b5b611e288254611c2f565b611e33828285611d73565b5f60209050601f831160018114611e64575f8415611e52578287015190505b611e5c8582611de1565b865550611ec3565b601f198416611e7286611c5f565b5f5b82811015611e9957848901518255600182019150602085019450602081019050611e74565b86831015611eb65784890151611eb2601f891682611dc5565b8355505b6001600288020188555050505b505050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f611f02826110f8565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611f3457611f33611ecb565b5b600182019050919050565b5f611f49826110f8565b9150611f54836110f8565b9250828201905080821115611f6c57611f6b611ecb565b5b92915050565b5f6060820190508181035f830152611f8a81866114f3565b9050611f996020830185611101565b611fa66040830184611101565b94935050505056fea2646970667358221220d93a9c39fee6c1f917f61b61143ea86bd798fa639a54865e51f9a78ee4f0612664736f6c63430008140033";

        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showMessage('MetaMask not installed!', 'error');
                    log('ERROR: MetaMask not detected');
                    return;
                }

                log('Requesting accounts...');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                log('Accounts received: ' + accounts[0]);

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.ready;
                
                signer = provider.getSigner();
                account = await signer.getAddress();

                log('Provider initialized successfully');
                
                const network = await provider.getNetwork();
                log('Connected to Chain ID: ' + network.chainId);

                if (network.chainId !== 252501) {
                    showMessage('Please switch to DIDLab network (Chain ID: 252501)', 'error');
                    log('Wrong network! Need Chain ID 252501');
                    return;
                }

                const balance = await signer.getBalance();
                const balanceInTT = ethers.utils.formatEther(balance);

                document.getElementById('status').textContent = 'Connected';
                document.getElementById('account').textContent = account;
                document.getElementById('balance').textContent = balanceInTT + ' TT';

                document.getElementById('connectBtn').disabled = true;
                document.getElementById('deployPRBtn').disabled = false;
                document.getElementById('deployPaymentBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = false;

                showMessage('Connected successfully!', 'success');
                log('Balance: ' + balanceInTT + ' TT');

                deploymentData.deployer = account;

            } catch (error) {
                showMessage('Connection failed: ' + error.message, 'error');
                log('ERROR: ' + error.message);
                console.error('Full error:', error);
            }
        }

        async function deployPatientRegistry() {
            const btn = document.getElementById('deployPRBtn');
            btn.disabled = true;
            btn.textContent = 'Deploying...';

            try {
                log('\n=== Deploying PatientRegistry ===');
                
                log('Creating contract factory...');
                const factory = new ethers.ContractFactory(
                    PATIENT_REGISTRY_ABI, 
                    PATIENT_REGISTRY_BYTECODE, 
                    signer
                );
                
                log('Deploying contract...');
                showMessage('Please confirm the transaction in MetaMask...', 'info');
                
                const contract = await factory.deploy();
                log('Transaction sent: ' + contract.deployTransaction.hash);
                showMessage('Transaction sent! Waiting for confirmation...', 'info');
                
                log('Waiting for deployment confirmation...');
                await contract.deployed();
                
                log(' PatientRegistry deployed at: ' + contract.address);
                showMessage(' PatientRegistry deployed successfully at: ' + contract.address, 'success');
                
                deploymentData.contracts.PatientRegistry = {
                    address: contract.address,
                    txHash: contract.deployTransaction.hash,
                    deployer: account,
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                showMessage('Deployment failed: ' + error.message, 'error');
                log('ERROR: ' + error.message);
                console.error('Full error:', error);
            } finally {
                btn.textContent = 'Deploy PatientRegistry';
                btn.disabled = false;
            }
        }

        async function deployPayment() {
            const btn = document.getElementById('deployPaymentBtn');
            btn.disabled = true;
            btn.textContent = 'Deploying...';

            try {
                log('\n=== Deploying Payment Contract ===');
                
                log('Creating contract factory...');
                const factory = new ethers.ContractFactory(
                    PAYMENT_ABI, 
                    PAYMENT_BYTECODE, 
                    signer
                );
                
                log('Deploying contract...');
                showMessage('Please confirm the transaction in MetaMask...', 'info');
                
                const contract = await factory.deploy();
                log('Transaction sent: ' + contract.deployTransaction.hash);
                showMessage('Transaction sent! Waiting for confirmation...', 'info');
                
                log('Waiting for deployment confirmation...');
                await contract.deployed();
                
                log(' Payment contract deployed at: ' + contract.address);
                showMessage(' Payment contract deployed successfully at: ' + contract.address, 'success');
                
                deploymentData.contracts.Payment = {
                    address: contract.address,
                    txHash: contract.deployTransaction.hash,
                    deployer: account,
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                showMessage('Deployment failed: ' + error.message, 'error');
                log('ERROR: ' + error.message);
                console.error('Full error:', error);
            } finally {
                btn.textContent = 'Deploy Payment';
                btn.disabled = false;
            }
        }

        function showMessage(msg, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type;
            msgDiv.textContent = msg;
            msgDiv.style.display = 'block';
        }

        function downloadDeployment() {
            const dataStr = JSON.stringify(deploymentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'didlab-deployment.json';
            link.click();
            log(' Downloaded deployment.json');
        }

        // Network change listeners
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                log('Network changed to: ' + chainId);
                window.location.reload();
            });

            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    log('MetaMask is locked');
                    showMessage('MetaMask is locked', 'error');
                } else {
                    log('Account changed to: ' + accounts[0]);
                    window.location.reload();
                }
            });
        }

        // Check on page load
        window.addEventListener('load', async () => {
            if (typeof ethers !== 'undefined') {
                log(' Ethers.js loaded successfully (v' + ethers.version + ')');
            } else {
                log(' Failed to load ethers.js');
                showMessage('Failed to load ethers.js library', 'error');
            }

            if (typeof window.ethereum !== 'undefined') {
                log(' MetaMask detected');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_accounts' 
                });
                if (accounts.length > 0) {
                    log('Previously connected account found: ' + accounts[0]);
                }
            } else {
                log(' MetaMask not detected');
            }
        });
    </script>
</body>
</html>